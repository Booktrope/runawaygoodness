var activeTinyEditor="";var current_modal_id="";var current_editor_id="";var current_editor_wrapper_id="";var current_editor_container_id="";var imc_styles={};var email_html="";var tinymceBodyBackgroundColor="";jQuery(document).ready(function(h){delete postL10n.saveAlert;var k={editor:"",inputs:{},close:function(){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}else{tinyMCE.get(tinyMCE.activeEditor.id).focus()}h("#wp-link-backdrop").hide();h("#wp-link-wrap").hide();h(document).trigger("wplink-close",h("#wp-link-wrap"))}};h.extend(wpLink,k);h('input[name="post_title"]').attr("tabindex","99").on("keydown",function(n){var o=n.keyCode||n.which;if(9==o){n.preventDefault();setTimeout(function(){h("#imc_email_subject").focus()},500)}});h(".postbox").each(function(n,o){h(this).removeClass("postbox").addClass("stuffbox");if(h(this).has(".handlediv")){h(this).children(".handlediv").remove()}if(h(this).has("h3")){h(this).children("h3").css("cursor","default")}});var b=h(".template.clearfix").height();h("select.list-select").change(function(){var o=h(this).val();var n=h(this).data("ajaxAction");h("input[name=imc_from_email]").val("");h("input[name=imc_from_name]").val("");h(this).parent().nextAll("div.clearfix").css("position","absolute").addClass("template-loading");h.getJSON(ajaxurl,{action:n,email_action:"load_segments_and_defaults",list_id:o,post_id:h("#post_ID").val()}).done(function(q){var p=q.lists;h("input[name=imc_from_email]").val(p.default_from_email);h("input[name=imc_from_name]").val(p.default_from_name);h("#groups_holder").html(q.groups[o].html).removeClass("hide");h("#segments_holder").html(q.segments[o].html).removeClass("hide");h(".template-loading").removeClass("template-loading")})});setTimeout(function(){h("select.list-select").change();e()},500);h("select.template-select").change(function(){h("div[id^='imc_modal_']").remove();if(typeof(tinyMCE)!=="undefined"){var o=tinyMCE.editors.length;for(var n=o;n>0;n--){tinyMCE.editors[n-1].remove()}}h("select.template-select").not(this).val("none");var p=h(this).data("ajaxAction");var r=h("#"+h(this).data("ajaxTarget"));h(r).contents().find("html").html("");h(".template.clearfix").height(b).addClass("template-loading");var q=h(this).val();h.post(ajaxurl,{action:p,value:q},function(u){var v=h(r).contents().find("html").get(0);v.innerHTML=u.source;h("#imc_content").text(u.source);c(r);var s=h(r.contents()),t;t=s.find("img").map(f);h.when.apply(h,t).done(function(){var w=h(r).contents().find("body").outerHeight(true);h(r).height(w+60);h(".template.clearfix").removeClass("template-loading").height("100%");g(v);h(r).removeClass("hidden").addClass("show")})})});var m={id:"",element:"",attachment:"",email_html:"",size:"",openMediaDialog:function(o,n){this.id=o;this.element=n;if(this._frame){this._frame.open();return}this._frame=m.frame=wp.media({title:"Choose Image",frame:"post",library:{type:"image"},button:{text:"Choose Image"},multiple:false,state:"insert"});this._frame.on("ready",function(){h(".media-menu-item:last-child").remove()});this._frame.on("insert",function(){var p=m.frame.$el.parent().find("select[name=size]").val();m.attachment=m.frame.state().get("selection").first().toJSON();if(0>h.trim(m.attachment.url.length)){return}m.handleMediaAttachment(p)});this._frame.on("select",function(){});this._frame.open()},handleMediaAttachment:function(n){h(this.element).attr("src",this.attachment.sizes[n].url);h(this.element).attr("width",this.attachment.sizes[n].width+"px").attr("alt",this.attachment.caption).attr("title",this.attachment.title);m.updatePostContent()},updatePostContent:function(){m.email_html=h("#template_holder").contents().find("html").clone();h(m.email_html).find(".tinymce_enabled.image").children("img").unwrap();h(m.email_html).find(".tinymce_enabled").removeClass("tinymce_enabled");h("#imc_content").text("<html>"+h(m.email_html).html()+"</html>")}};function g(q){var p=h(q).find("style").text();var o=h(q).find("[mc\\:edit]");var n={};h(q).find("a").click(function(r){r.preventDefault()});h(o).each(function(r,s){if(h(s).attr("mc:label")!==undefined&&h(s).attr("mc:label")!==false){h(s).wrap("<div></div>").parent().addClass("tinymce_enabled image").hover(function(){h(s).parent().prepend("<span class='imc_img_specs'>Use an image with the following dimensions: width = "+h(s).width()+"px, height = "+h(s).height()+"px</span>")},function(){h(this).children(".imc_img_specs").remove()}).on("click",function(){h(this).children(".imc_img_specs").remove();m.openMediaDialog(h(s).attr("mc:edit"),h(s))})}else{h(s).addClass("tinymce_enabled").click(function(){var w=h(this).attr("mc:edit");current_modal_id="imc_modal_"+w;if(typeof(tinyMCE)=="object"&&typeof(tinyMCE.execCommand)=="function"){current_editor_id="imc_"+w+"_editor";current_editor_wrapper_id="wp-"+current_editor_id+"-wrap";current_editor_container_id="wp-"+current_editor_id+"-editor-container";h("body").append("                        <div class='modal fade' id='"+current_modal_id+"' class='imc_email_campaign_editor_modal'>\n                            <div class='modal-dialog'>\n                                <div class='modal-content wp-core-ui wp-editor-wrap html-active has-dfw' id='"+current_editor_wrapper_id+"'>\n                                    <div class='modal-header'>\n                                    </div>\n                                    <div class='modal-body wp-editor-container' id='"+current_editor_container_id+"'>\n                                        <textarea class='wp-editor-area imc_mceEditor' style='height: 350px; width: 100%;' name='"+current_editor_id+"' id='"+current_editor_id+"'></textarea>\n                                    </div>\n                                    <div class='modal-footer'>\n                                        <button type='button' class='btn btn-default' data-dismiss='modal'>Close</button>\n                                        <button type='button' name='imc_text_modal_submit' class='btn btn-primary'>Save changes</button>\n                                     </div>\n                                </div>\n                            </div>\n                        </div>");h("button[name=imc_text_modal_submit]").on("click",function(B){if(tinyMCE.activeEditor.isNotDirty==false){var x=tinyMCE.activeEditor.getContent();x=h(x).html();h(s).html(x);var A=h("#template_holder").contents().find("html").clone().find(".tinymce_enabled").removeClass("tinymce_enabled").end().find("#imc_styles").remove().end().html();h("#imc_content").text("<html>"+A+"</html>")}h("#"+current_modal_id).modal("hide");h("#"+current_modal_id).remove();h(".modal-backdrop").remove();if(typeof(tinyMCE)!=="undefined"){var z=tinyMCE.editors.length;for(var y=z;y>0;y--){tinyMCE.editors[y-1].remove()}}});tinyMCEPreInit.mceInit[current_editor_id]=tinyMCEPreInit.mceInit.content;tinyMCEPreInit.mceInit[current_editor_id].selector="#"+current_editor_id;tinyMCEPreInit.mceInit[current_editor_id].resize=true;tinyMCEPreInit.mceInit[current_editor_id].forced_root_block=false;tinyMCEPreInit.mceInit[current_editor_id].keep_styles=false;h("#"+current_modal_id).modal();a();h("#"+current_editor_id+"_ifr").contents().find("style").html(p);h("#"+current_editor_id+"_ifr").contents().find("link[rel=stylesheet]").prop("disabled",true).remove();try{var u=h("<div />").append(h(s).clone().removeClass("tinymce_enabled").attr("id","imc_"+w)).html();if(h(this).prop("tagName")=="TD"){u="<div id='imc_"+w+"'>"+u+"</div>"}tinyMCE.get(current_editor_id).setContent(u);var t="#imc_"+w+"{"+l(s)+"}";h(s).children().each(function(x,y){t+="#imc_"+w+" "+h(y).prop("tagName")+"{"+l(y)+"}"});h("#"+current_editor_id+"_ifr").contents().find("body").css("background-color",tinymceBodyBackgroundColor);imc_styles[w]=h("<style>",{id:w,type:"text/css",html:t}).appendTo(h("#"+current_editor_id+"_ifr").contents().find("head"));tinymceBodyBackgroundColor=""}catch(v){console.log(v)}}else{alert("tinyMCE Editor not available!")}})}})}function f(){var n=h.Deferred();this.onload=function o(){n.resolve()};return n}function c(n){imc_styles.tinymce_enabled=h("<style>",{id:"imc_styles",type:"text/css",html:"                        .tinymce_enabled{position:relative;}\n                        .tinymce_enabled:hover:after{\n                        content:' ';\n                        position:absolute;\n                        width:100%;\n                        height:100%;\n                        top:0;\n                        left:0;\n                        background-color: #2ba9c0;\n                        opacity: .5;\n                        filter:alpha(opacity=50);\n                        z-index: 9999;}\n                        .imc_img_specs{\n                        position:absolute;\n                        background-color:black;\n                        color: white;\n                        padding:6px;\n                        font-size:14px;\n                        z-index: 10000;\n                        font-family: Arial, Helvetica, sans-serif;\n                        font-weight: bold;\n                        }"}).appendTo(h(n).contents().find("head"))}function e(){var q=h("#template_holder");var p=h("#imc_content").val();var r=h(q).contents().find("html").get(0);r.innerHTML=p;c(q);var n=h(q.contents()),o;o=n.find("img").map(f);h.when.apply(h,o).done(function(){var s=h(q).contents().find("body").outerHeight(true);h(q).height(s+60);h(".template.clearfix").removeClass("template-loading").height("100%");g(r);h(q).removeClass("hidden").addClass("show")});h(q).removeClass("hide")}function l(o){var q=false;var p="";var n=new Array("background","background-color","color","font","font-family","font-size","font-style","font-variant","font-weight","line-height","list-style","margin","padding","text-align","text-decoration","text-indent","text-shadow","text-transform");if(o.currentStyle){q=o.currentStyle}else{if(window.getComputedStyle){q=document.defaultView.getComputedStyle(o,null)}}if(!q){return null}for(var r in q){if(h.inArray(r,n)!=-1){if(q[r]!=undefined&&q[r].length>0&&typeof q[r]!=="object"&&typeof q[r]!=="function"&&r!=parseInt(r)){p+=r+":"+q[r]+";\n "}}}if(h.inArray("backgroundColor",n)==-1){i(o)}return p}function i(n){var o=h(n).parent();var p=h(o).css("background-color");if(p=="transparent"||p=="rgba(0, 0, 0, 0)"){return i(o)}else{tinymceBodyBackgroundColor=p;return}}function d(o,q,p,n){if(o=="visual"){tinyMCE.execCommand("mceAddEditor",false,n);h(q).addClass("active");h(p).removeClass("active")}else{if(o=="html"){tinyMCE.execCommand("mceRemoveEditor",false,n);h(q).removeClass("active");h(p).addClass("active")}}}h("button.imc-email-process").click(function(o){o.preventDefault();h("#imc-email-campaign-message").html("").addClass("template-loading").show();var n=h(this).data("ajaxAction");var p=h(this).closest("form").serialize();h.post(ajaxurl,{form_data:p,action:"ajax_save_campaign",current_action:n},function(s){var r="updated";var t=null;if(s instanceof Array||s instanceof Object){for(var q in s){t=null;switch(q){case"msg":t=s[q];break;case"cid":h("input[name=imc_campaign_id]").val(s[q]);break;case"reload":setTimeout(function(){window.location=s[q]},2000);break;default:t="<div>"+s[q]+"</div>";r="error";h("#"+q).addClass("highlight-error");break}if(t){h("#imc-email-campaign-message").append(t)}}}h("#imc-email-campaign-message").hide().removeClass("error").removeClass("updated, template-loading").addClass(r).show()})});var j=false;function a(){var r,p,o,n,s;if(typeof tinyMCE!=="undefined"){for(p in tinyMCEPreInit.mceInit){if(p!=="content"){if(n){r=tinyMCEPreInit.mceInit[p]=tinyMCE.extend({},n,tinyMCEPreInit.mceInit[p])}else{r=n=tinyMCEPreInit.mceInit[p]}s=tinyMCE.DOM.select("#wp-"+p+"-wrap")[0];if(true){try{tinyMCE.init(r);j=true;if(!window.wpActiveEditor){window.wpActiveEditor=p}}catch(q){console.log("Error initializing tinyMCE: ");console.log(q)}}else{}}else{}}}if(typeof quicktags!=="undefined"){for(o in tinyMCEPreInit.qtInit){if(o!=="content"){try{quicktags(tinyMCEPreInit.qtInit[o]);if(!window.wpActiveEditor){window.wpActiveEditor=o}}catch(q){console.log("Error initializing tinyMCE QuickTags: ");console.log(q)}}}}else{console.log("---- quicktags() is undefined -----")}if(!j){if(typeof jQuery!=="undefined"){jQuery(".wp-editor-wrap").on("click.wp-editor",function(){if(this.id){window.wpActiveEditor=this.id.slice(3,-5)}})}else{for(o in tinyMCEPreInit.qtInit){if(o!=="content"){document.getElementById("wp-"+o+"-wrap").onclick=function(){window.wpActiveEditor=this.id.slice(3,-5)}}}}}}});